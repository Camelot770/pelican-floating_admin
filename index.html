<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>–ü–µ–ª–∏–∫–∞–Ω ‚Äî –ê–¥–º–∏–Ω v3.0</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-card: #1a1a24;
            --text-primary: #ffffff;
            --text-secondary: #8b8b9e;
            --accent-cyan: #00d4ff;
            --accent-green: #00ff88;
            --accent-orange: #ff9500;
            --accent-red: #ff5252;
            --accent-purple: #a855f7;
            --border-color: rgba(255,255,255,0.08);
        }
        [data-theme="pelican"] {
            --bg-primary: #f9fafb; --bg-secondary: #ffffff; --bg-card: #ffffff;
            --text-primary: #1e3a8a; --text-secondary: #6b7280; --accent-cyan: #1e3a8a;
            --accent-green: #059669; --accent-orange: #f59e0b; --accent-red: #dc2626;
            --accent-purple: #7c3aed; --border-color: rgba(30, 58, 138, 0.1);
        }
        [data-theme="pelican"] .header { background: linear-gradient(135deg, rgba(30,58,138,0.08), rgba(59,130,246,0.08)); }
        [data-theme="pelican"] .nav-tab.active { background: linear-gradient(135deg, #1e3a8a, #3b82f6); color: white; }
        [data-theme="pelican"] .btn-primary { background: linear-gradient(135deg, #1e3a8a, #3b82f6); }
        .theme-toggle { position: fixed; bottom: 80px; right: 16px; width: 48px; height: 48px; border-radius: 50%; background: var(--bg-card); border: 1px solid var(--border-color); display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: var(--bg-primary); color: var(--text-primary); min-height: 100vh; }
        .header { background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(168,85,247,0.1)); padding: 20px; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 20px; display: flex; align-items: center; gap: 8px; }
        .header .subtitle { color: var(--text-secondary); font-size: 13px; margin-top: 4px; }
        .refresh-btn { width: 40px; height: 40px; border: none; background: var(--bg-card); border-radius: 50%; font-size: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .refresh-btn.spinning { animation: spin 0.8s ease-in-out; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 16px; }
        .stat-card { background: var(--bg-card); border-radius: 12px; padding: 12px 8px; text-align: center; }
        .stat-value { font-size: 24px; font-weight: 700; color: var(--accent-cyan); }
        .stat-label { font-size: 10px; color: var(--text-secondary); margin-top: 4px; }
        .nav-tabs { display: flex; background: var(--bg-secondary); padding: 8px; gap: 4px; position: sticky; top: 0; z-index: 100; }
        .nav-tab { flex: 1; padding: 10px 4px; background: transparent; border: none; border-radius: 10px; color: var(--text-secondary); font-size: 11px; cursor: pointer; display: flex; flex-direction: column; align-items: center; gap: 4px; }
        .nav-tab.active { background: var(--bg-card); color: var(--accent-cyan); }
        .nav-tab-icon { font-size: 18px; }
        .content { padding: 16px; padding-bottom: 100px; }
        .section { display: none; } .section.active { display: block; }
        .section-title { font-size: 18px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
        .filter-btn { padding: 8px 16px; border-radius: 20px; border: 1px solid var(--border-color); background: var(--bg-card); color: var(--text-secondary); font-size: 13px; font-weight: 500; cursor: pointer; white-space: nowrap; }
        .filter-btn.active { background: var(--accent-cyan); color: white; border-color: var(--accent-cyan); }
        .service-card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border-color); cursor: pointer; }
        .service-card:hover { border-color: var(--accent-cyan); }
        .service-card.inactive { opacity: 0.5; }
        .service-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
        .service-name { font-weight: 600; font-size: 15px; }
        .service-status { font-size: 12px; padding: 4px 8px; border-radius: 12px; font-weight: 500; }
        .service-status.active { background: rgba(0, 255, 136, 0.15); color: var(--accent-green); }
        .service-status.inactive { background: rgba(255, 82, 82, 0.15); color: var(--accent-red); }
        .service-meta { display: flex; gap: 16px; color: var(--text-secondary); font-size: 14px; }
        .service-price { font-weight: 600; color: var(--accent-cyan); }
        .service-category { font-size: 12px; color: var(--text-secondary); margin-top: 8px; }
        .card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; border: 1px solid var(--border-color); }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
        .booking-card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--accent-cyan); }
        .booking-card.cancelled { border-left-color: var(--accent-red); opacity: 0.6; }
        .booking-time { font-size: 24px; font-weight: 700; color: var(--accent-cyan); }
        .booking-service { font-weight: 500; margin: 8px 0 4px; }
        .booking-client { color: var(--text-secondary); font-size: 14px; }
        .booking-actions { display: flex; gap: 8px; margin-top: 12px; }
        .cert-card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; border-left: 4px solid var(--accent-orange); }
        .cert-card.paid { border-left-color: var(--accent-green); }
        .cert-card.used { border-left-color: var(--text-secondary); opacity: 0.6; }
        .cert-status { display: inline-block; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 500; }
        .cert-status.pending { background: rgba(255,149,0,0.2); color: var(--accent-orange); }
        .cert-status.paid { background: rgba(0,255,136,0.2); color: var(--accent-green); }
        .cert-status.used { background: rgba(139,139,158,0.2); color: var(--text-secondary); }
        .client-card { background: var(--bg-card); border-radius: 16px; padding: 16px; margin-bottom: 12px; display: flex; align-items: center; gap: 12px; }
        .client-avatar { width: 48px; height: 48px; border-radius: 50%; background: linear-gradient(135deg, var(--accent-cyan), var(--accent-purple)); display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: 600; }
        .client-info { flex: 1; } .client-name { font-weight: 600; } .client-phone { color: var(--text-secondary); font-size: 14px; }
        .client-stats { text-align: right; font-size: 13px; color: var(--text-secondary); }
        .btn { padding: 10px 16px; border-radius: 10px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; }
        .btn-primary { background: linear-gradient(135deg, var(--accent-cyan), var(--accent-green)); color: #000; }
        .btn-secondary { background: var(--bg-secondary); color: var(--text-primary); }
        .btn-danger { background: rgba(255,82,82,0.2); color: var(--accent-red); }
        .btn-success { background: rgba(0,255,136,0.2); color: var(--accent-green); }
        .btn-warning { background: rgba(255,149,0,0.2); color: var(--accent-orange); }
        .btn-small { padding: 8px 12px; font-size: 12px; }
        .date-selector { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 8px; margin-bottom: 16px; }
        .date-item { flex-shrink: 0; width: 56px; padding: 12px 8px; background: var(--bg-card); border-radius: 12px; text-align: center; cursor: pointer; border: 2px solid transparent; }
        .date-item.active { border-color: var(--accent-cyan); background: rgba(0,212,255,0.1); }
        .date-day { font-size: 10px; color: var(--text-secondary); text-transform: uppercase; }
        .date-num { font-size: 20px; font-weight: 700; margin-top: 4px; }
        .date-count { font-size: 10px; color: var(--accent-cyan); margin-top: 4px; }
        .setting-item { display: flex; justify-content: space-between; align-items: center; padding: 16px 0; border-bottom: 1px solid var(--border-color); }
        .setting-item:last-child { border: none; }
        .setting-label { display: flex; align-items: center; gap: 12px; }
        .setting-icon { width: 40px; height: 40px; border-radius: 10px; background: var(--bg-secondary); display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .setting-value { color: var(--text-secondary); font-size: 14px; }
        .slots-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 16px; }
        .slot-item { padding: 12px 8px; background: var(--bg-secondary); border-radius: 10px; text-align: center; cursor: pointer; border: 2px solid transparent; font-size: 14px; }
        .slot-item.available { background: rgba(0,255,136,0.1); border-color: rgba(0,255,136,0.3); }
        .slot-item.booked { background: rgba(0,212,255,0.1); border-color: var(--accent-cyan); color: var(--accent-cyan); }
        .slot-item.blocked { background: rgba(255,82,82,0.1); border-color: var(--accent-red); color: var(--accent-red); }
        .empty-state { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .empty-icon { font-size: 48px; margin-bottom: 16px; }
        .search-box { background: var(--bg-card); border-radius: 12px; padding: 12px 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 16px; }
        .search-input { flex: 1; background: transparent; border: none; color: var(--text-primary); font-size: 16px; outline: none; }
        .search-input::placeholder { color: var(--text-secondary); }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal.active { display: flex; }
        .modal-content { background: var(--bg-card); border-radius: 20px; padding: 24px; width: 100%; max-width: 400px; max-height: 80vh; overflow-y: auto; }
        .modal-title { font-size: 20px; font-weight: 600; margin-bottom: 16px; text-align: center; }
        .modal-actions { display: flex; gap: 12px; margin-top: 20px; }
        .modal-actions .btn { flex: 1; }
        .input-group { margin-bottom: 16px; }
        .input-label { display: block; color: var(--text-secondary); font-size: 13px; margin-bottom: 8px; }
        .input-field { width: 100%; padding: 14px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 12px; color: var(--text-primary); font-size: 16px; outline: none; }
        .input-field:focus { border-color: var(--accent-cyan); }
        .loading { display: flex; align-items: center; justify-content: center; padding: 40px; }
        .spinner { width: 40px; height: 40px; border: 3px solid var(--bg-secondary); border-top-color: var(--accent-cyan); border-radius: 50%; animation: spin 1s linear infinite; }
        .filter-tabs { display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; }
        .filter-tab { padding: 8px 16px; background: var(--bg-card); border-radius: 20px; font-size: 13px; cursor: pointer; white-space: nowrap; border: 1px solid var(--border-color); }
        .filter-tab.active { background: var(--accent-cyan); color: #000; border-color: var(--accent-cyan); }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>ü¶© –ü–µ–ª–∏–∫–∞–Ω <span style="color: var(--accent-purple)">–ê–¥–º–∏–Ω</span></h1>
            <div class="subtitle" id="todayDate">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
        </div>
        <button class="refresh-btn" onclick="refreshApp()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</button>
    </div>
    
    <div class="stats-row">
        <div class="stat-card"><div class="stat-value" id="statToday">-</div><div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div></div>
        <div class="stat-card"><div class="stat-value" id="statWeek">-</div><div class="stat-label">–ù–µ–¥–µ–ª—è</div></div>
        <div class="stat-card"><div class="stat-value" id="statClients">-</div><div class="stat-label">–ö–ª–∏–µ–Ω—Ç—ã</div></div>
        <div class="stat-card"><div class="stat-value" id="statCerts">-</div><div class="stat-label">–°–µ—Ä—Ç.</div></div>
    </div>
    
    <nav class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('schedule')"><span class="nav-tab-icon">üìÖ</span><span>–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ</span></button>
        <button class="nav-tab" onclick="switchTab('certs')"><span class="nav-tab-icon">üéÅ</span><span>–°–µ—Ä—Ç-—Ç—ã</span></button>
        <button class="nav-tab" onclick="switchTab('services')"><span class="nav-tab-icon">üìã</span><span>–£—Å–ª—É–≥–∏</span></button>
        <button class="nav-tab" onclick="switchTab('clients')"><span class="nav-tab-icon">üë•</span><span>–ö–ª–∏–µ–Ω—Ç—ã</span></button>
        <button class="nav-tab" onclick="switchTab('settings')"><span class="nav-tab-icon">‚öôÔ∏è</span><span>‚öôÔ∏è</span></button>
    </nav>
    
    <div class="content">
        <section id="scheduleTab" class="section active">
            <div class="date-selector" id="dateSelector"></div>
            <div class="card-header">
                <div class="card-title">üìã –ó–∞–ø–∏—Å–∏ –Ω–∞ <span id="selectedDateText">—Å–µ–≥–æ–¥–Ω—è</span></div>
                <button class="btn btn-small btn-secondary" onclick="showBlockDayModal()">üö´ –í—ã—Ö–æ–¥–Ω–æ–π</button>
            </div>
            <div id="bookingsList"></div>
            <div class="section-title" style="margin-top: 24px;">üïê –°–ª–æ—Ç—ã</div>
            <div class="slots-grid" id="slotsGrid"></div>
        </section>
        
        <section id="certsTab" class="section">
            <div class="card" style="background: linear-gradient(135deg, rgba(0,212,255,0.1), rgba(0,255,136,0.1)); margin-bottom: 16px;">
                <div style="text-align: center; margin-bottom: 12px;">
                    <span style="font-size: 32px;">üîë</span>
                    <div style="font-weight: 600; margin-top: 8px;">–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞</div>
                </div>
                <div style="display: flex; gap: 8px;">
                    <input type="text" id="certCodeInput" class="input-field" placeholder="12345" style="text-align: center; font-size: 24px; letter-spacing: 4px; font-weight: 600;" maxlength="5" inputmode="numeric">
                    <button class="btn btn-primary" onclick="checkCertCode()">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
                </div>
            </div>
            <div class="filter-tabs">
                <div class="filter-tab active" onclick="filterCerts('pending')">‚è≥ –û–∂–∏–¥–∞—é—Ç</div>
                <div class="filter-tab" onclick="filterCerts('paid')">‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ</div>
                <div class="filter-tab" onclick="filterCerts('used')">üé´ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã</div>
                <div class="filter-tab" onclick="filterCerts('all')">–í—Å–µ</div>
            </div>
            <div id="certsList"></div>
        </section>
        
        <section id="servicesTab" class="section">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                <div class="section-title" style="margin: 0;">üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å–ª—É–≥–∞–º–∏</div>
                <button class="btn btn-small btn-primary" onclick="showAddServiceModal()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
            </div>
            <div style="display: flex; gap: 8px; margin-bottom: 16px; overflow-x: auto; padding-bottom: 8px;">
                <button class="filter-btn active" data-category="all" onclick="filterServices('all')">–í—Å–µ</button>
                <button class="filter-btn" data-category="floating" onclick="filterServices('floating')">üåä –§–ª–æ–∞—Ç–∏–Ω–≥</button>
                <button class="filter-btn" data-category="couples" onclick="filterServices('couples')">üíï –î–ª—è –¥–≤–æ–∏—Ö</button>
                <button class="filter-btn" data-category="massage" onclick="filterServices('massage')">üíÜ –ú–∞—Å—Å–∞–∂</button>
                <button class="filter-btn" data-category="spa" onclick="filterServices('spa')">üßñ SPA</button>
            </div>
            <div id="servicesListFull"></div>
        </section>
        
        <section id="clientsTab" class="section">
            <div class="search-box">
                <span>üîç</span>
                <input type="text" class="search-input" placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏ –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É" oninput="searchClients(this.value)">
            </div>
            <div id="clientsList"></div>
        </section>
        
        <section id="settingsTab" class="section">
            <div class="section-title">üè¢ –ë–∏–∑–Ω–µ—Å</div>
            <div class="card">
                <div class="setting-item" onclick="editSetting('business_name')">
                    <div class="setting-label"><div class="setting-icon">üè∑</div><div><div>–ù–∞–∑–≤–∞–Ω–∏–µ</div><div class="setting-value" id="settingName">‚Äî</div></div></div><span>‚Ä∫</span>
                </div>
                <div class="setting-item" onclick="editSetting('business_address')">
                    <div class="setting-label"><div class="setting-icon">üìç</div><div><div>–ê–¥—Ä–µ—Å</div><div class="setting-value" id="settingAddress">‚Äî</div></div></div><span>‚Ä∫</span>
                </div>
                <div class="setting-item" onclick="editSetting('business_phone')">
                    <div class="setting-label"><div class="setting-icon">üìû</div><div><div>–¢–µ–ª–µ—Ñ–æ–Ω</div><div class="setting-value" id="settingPhone">‚Äî</div></div></div><span>‚Ä∫</span>
                </div>
            </div>
            <div class="section-title" style="margin-top: 24px;">üõ† –£—Å–ª—É–≥–∏</div>
            <div id="servicesList"></div>
            <div class="section-title" style="margin-top: 24px;">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</div>
            <div class="card">
                <div class="setting-item" onclick="showBroadcastModal()">
                    <div class="setting-label"><div class="setting-icon">üì®</div><div><div>–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É</div><div class="setting-value">–í—Å–µ–º –∫–ª–∏–µ–Ω—Ç–∞–º</div></div></div><span>‚Ä∫</span>
                </div>
            </div>
        </section>
    </div>
    
    <div class="modal" id="modal"><div class="modal-content" id="modalContent"></div></div>
    <button class="theme-toggle" onclick="toggleTheme()" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ç–µ–º—É">ü¶©</button>
    <script>
        const tg = window.Telegram?.WebApp;
        if (tg) { tg.ready(); tg.expand(); tg.enableClosingConfirmation(); }
        
        const API_URL = 'https://pelican-floating-camelot770.amvera.io';
        let scheduleData = {}, clientsData = [], certsData = [], settings = {}, currentCertFilter = 'pending';
        let allServicesData = [], currentServiceFilter = 'all';
        
        function getLocalDateString(date = new Date()) {
            return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        }
        let selectedDate = getLocalDateString();
        
        document.addEventListener('DOMContentLoaded', () => {
            updateTodayDate(); initDateSelector(); loadStats(); loadSchedule(selectedDate);
            loadCerts(); loadClients(); loadSettings();
            window.markCertPaid = markCertPaid; window.callClient = callClient; window.copyToClipboard = copyToClipboard;
            window.useCertByCode = useCertByCode; window.useCert = useCert; window.closeModal = closeModal;
            window.showClientDetails = showClientDetails; window.cancelBooking = cancelBooking;
            window.filterCerts = filterCerts; window.checkCertCode = checkCertCode;
        });
        
        function updateTodayDate() { document.getElementById('todayDate').textContent = new Date().toLocaleDateString('ru-RU', { weekday: 'long', day: 'numeric', month: 'long' }); }
        
        function switchTab(tabId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabId + 'Tab').classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabId === 'services') loadServices();
            haptic('light');
        }
        
        function haptic(type) { if (tg?.HapticFeedback) tg.HapticFeedback.impactOccurred(type); }
        
        function initDateSelector() {
            const container = document.getElementById('dateSelector');
            const days = ['–í–°', '–ü–ù', '–í–¢', '–°–†', '–ß–¢', '–ü–¢', '–°–ë'];
            for (let i = 0; i < 14; i++) {
                const date = new Date(); date.setDate(date.getDate() + i);
                const dateStr = getLocalDateString(date);
                const item = document.createElement('div');
                item.className = 'date-item' + (i === 0 ? ' active' : '');
                item.dataset.date = dateStr;
                item.innerHTML = `<div class="date-day">${days[date.getDay()]}</div><div class="date-num">${date.getDate()}</div><div class="date-count" id="count-${dateStr}">‚Äî</div>`;
                item.onclick = () => selectDate(dateStr);
                container.appendChild(item);
            }
        }
        
        function selectDate(dateStr) {
            selectedDate = dateStr;
            document.querySelectorAll('.date-item').forEach(el => el.classList.toggle('active', el.dataset.date === dateStr));
            document.getElementById('selectedDateText').textContent = new Date(dateStr).toLocaleDateString('ru-RU', { day: 'numeric', month: 'long' });
            loadSchedule(dateStr); haptic('light');
        }
        
        async function apiCall(endpoint, options = {}) {
            try {
                const response = await fetch(`${API_URL}${endpoint}`, { headers: { 'Content-Type': 'application/json', ...options.headers }, ...options });
                return await response.json();
            } catch (e) { console.error('API error:', e); return null; }
        }
        
        async function loadStats() {
            const data = await apiCall('/api/admin/stats');
            if (data) {
                document.getElementById('statToday').textContent = data.today_bookings || 0;
                document.getElementById('statWeek').textContent = data.week_bookings || 0;
                document.getElementById('statClients').textContent = data.total_clients || 0;
                document.getElementById('statCerts').textContent = data.pending_certs || 0;
            }
        }
        
        async function loadSchedule(date) {
            const container = document.getElementById('bookingsList');
            container.innerHTML = '<div class="loading"><div class="spinner"></div></div>';
            const data = await apiCall(`/api/admin/schedule/${date}`);
            if (!data || !data.bookings || data.bookings.length === 0) {
                container.innerHTML = '<div class="empty-state"><div class="empty-icon">üì≠</div><div>–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π –Ω–∞ —ç—Ç–æ—Ç –¥–µ–Ω—å</div></div>';
            } else {
                container.innerHTML = data.bookings.map(b => `
                    <div class="booking-card ${b.status === 'cancelled' ? 'cancelled' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start;">
                            <div>
                                <div class="booking-time">${b.time}</div>
                                <div class="booking-service">${b.service_name}</div>
                                <div class="booking-client">üë§ ${b.first_name || '–ö–ª–∏–µ–Ω—Ç'} ¬∑ <a href="tel:${b.phone}" style="color: var(--accent-cyan)">${b.phone || '‚Äî'}</a></div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--accent-green); font-weight: 600;">${(b.price || 0).toLocaleString()} ‚ÇΩ</div>
                                <div style="font-size: 11px; color: var(--text-secondary);">#${b.id}</div>
                            </div>
                        </div>
                        ${b.status === 'confirmed' ? `<div class="booking-actions"><button class="btn btn-small btn-secondary" onclick="callClient('${b.phone}')">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button><button class="btn btn-small btn-danger" onclick="cancelBooking('${b.id}')">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å</button></div>` : '<div style="color: var(--accent-red); margin-top: 8px; font-size: 13px;">–û—Ç–º–µ–Ω–µ–Ω–æ</div>'}
                    </div>`).join('');
            }
            renderSlots(data?.slots || []);
            const countEl = document.getElementById(`count-${date}`);
            if (countEl) { const cnt = (data?.bookings || []).filter(b => b.status === 'confirmed').length; countEl.textContent = cnt > 0 ? cnt : '‚Äî'; }
        }
        
        function renderSlots(slots) {
            const grid = document.getElementById('slotsGrid');
            const slotTimes = [];
            for (let h = 10; h < 20; h++) { slotTimes.push(`${h.toString().padStart(2, '0')}:00`); slotTimes.push(`${h.toString().padStart(2, '0')}:30`); }
            grid.innerHTML = slotTimes.map(time => {
                const slot = slots.find(s => s.time === time) || {};
                let className = 'slot-item';
                if (slot.status === 'booked') className += ' booked';
                else if (slot.status === 'blocked') className += ' blocked';
                else className += ' available';
                return `<div class="${className}" onclick="toggleSlot('${time}', '${slot.status || 'available'}')">${time}</div>`;
            }).join('');
        }
        
        function toggleSlot(time, currentStatus) {
            if (currentStatus === 'booked') { showToast('–°–ª–æ—Ç –∑–∞–Ω—è—Ç –∫–ª–∏–µ–Ω—Ç–æ–º'); return; }
            showModal(`<div class="modal-title">${time}</div><p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">${currentStatus === 'blocked' ? '–°–ª–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω' : '–°–ª–æ—Ç —Å–≤–æ–±–æ–¥–µ–Ω'}</p><div class="modal-actions">${currentStatus === 'blocked' ? `<button class="btn btn-success" onclick="unblockSlot('${time}')">‚úÖ –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>` : `<button class="btn btn-danger" onclick="blockSlot('${time}')">üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button>`}<button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`);
        }
        
        async function blockSlot(time) { await apiCall('/api/admin/slots/block', { method: 'POST', body: JSON.stringify({ date: selectedDate, time }) }); closeModal(); loadSchedule(selectedDate); showToast('–°–ª–æ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'); }
        async function unblockSlot(time) { await apiCall('/api/admin/slots/unblock', { method: 'POST', body: JSON.stringify({ date: selectedDate, time }) }); closeModal(); loadSchedule(selectedDate); showToast('–°–ª–æ—Ç —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'); }
        function showBlockDayModal() { showModal(`<div class="modal-title">üö´ –í—ã—Ö–æ–¥–Ω–æ–π –¥–µ–Ω—å</div><p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –¥–µ–Ω—å ${selectedDate}?</p><div class="modal-actions"><button class="btn btn-danger" onclick="blockDay()">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`); }
        async function blockDay() { await apiCall('/api/admin/slots/block-day', { method: 'POST', body: JSON.stringify({ date: selectedDate }) }); closeModal(); loadSchedule(selectedDate); showToast('–î–µ–Ω—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'); }
        async function cancelBooking(bookingId) { showModal(`<div class="modal-title">‚ùå –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞–ø–∏—Å—å?</div><p style="text-align: center; color: var(--text-secondary); margin-bottom: 20px;">–ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—Ç–º–µ–Ω–µ</p><div class="modal-actions"><button class="btn btn-danger" onclick="confirmCancelBooking('${bookingId}')">–û—Ç–º–µ–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–ù–∞–∑–∞–¥</button></div>`); }
        async function confirmCancelBooking(bookingId) { await apiCall(`/api/admin/bookings/${bookingId}/cancel`, { method: 'POST' }); closeModal(); loadSchedule(selectedDate); loadStats(); showToast('–ó–∞–ø–∏—Å—å –æ—Ç–º–µ–Ω–µ–Ω–∞'); }
        
        function callClient(phone) {
            if (!phone) { showToast('–ù–æ–º–µ—Ä –Ω–µ —É–∫–∞–∑–∞–Ω', 'error'); return; }
            const cleanPhone = phone.replace(/[\s\-\(\)]/g, '');
            showModal(`<div class="modal-title">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</div><div style="text-align: center; margin: 20px 0;"><div style="font-size: 24px; font-weight: 600; color: var(--accent-cyan);">${phone}</div></div><div class="modal-actions" style="flex-direction: column; gap: 10px;"><a href="tel:${cleanPhone}" class="btn btn-primary" style="text-decoration: none; text-align: center;">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</a><button class="btn btn-secondary" onclick="copyToClipboard('${cleanPhone}')">üìã –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
        }
        
        function copyToClipboard(text) { navigator.clipboard.writeText(text).then(() => showToast('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ')).catch(() => { const i = document.createElement('input'); i.value = text; document.body.appendChild(i); i.select(); document.execCommand('copy'); document.body.removeChild(i); showToast('‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ'); }); }
        
        // ============== CERTIFICATES ==============
        async function loadCerts() { const data = await apiCall('/api/admin/certificates'); if (data) { certsData = data; renderCerts(); } }
        
        function filterCerts(filter) {
            currentCertFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(el => {
                el.classList.toggle('active', el.textContent.toLowerCase().includes(filter === 'pending' ? '–æ–∂–∏–¥–∞—é—Ç' : filter === 'paid' ? '–∞–∫—Ç–∏–≤–Ω—ã–µ' : filter === 'used' ? '–∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã' : '–≤—Å–µ'));
            });
            renderCerts(); haptic('light');
        }
        
        function renderCerts() {
            const container = document.getElementById('certsList');
            let filtered = currentCertFilter !== 'all' ? certsData.filter(c => c.status === currentCertFilter) : certsData;
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">üéÅ</div><div>–ù–µ—Ç —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–≤</div></div>'; return; }
            container.innerHTML = filtered.map(c => `
                <div class="cert-card ${c.status}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 12px;">
                        <div><div style="font-weight: 600;">${c.cert_name}</div><div style="color: var(--accent-green); font-size: 18px; font-weight: 600;">${(c.price || 0).toLocaleString()} ‚ÇΩ</div></div>
                        <span class="cert-status ${c.status}">${c.status === 'pending' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç' : c.status === 'paid' ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : 'üé´ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'}</span>
                    </div>
                    ${c.redeem_code ? `<div style="background: rgba(0,255,136,0.1); border-radius: 12px; padding: 12px; margin-bottom: 12px; text-align: center;"><div style="font-size: 11px; color: var(--text-secondary);">–ö–û–î</div><div style="font-size: 24px; font-weight: 700; letter-spacing: 3px; color: var(--accent-green); font-family: monospace;">${c.redeem_code}</div></div>` : ''}
                    <div style="font-size: 14px; color: var(--text-secondary);">üë§ ${c.recipient_name} ¬∑ üì± ${c.recipient_email || '‚Äî'}</div>
                    <div style="font-size: 13px; color: var(--text-secondary); border-top: 1px solid var(--border-color); padding-top: 12px; margin-top: 12px;">–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${c.first_name || ''} ${c.buyer_phone || '‚Äî'} <span style="float: right;">#${c.id}</span></div>
                    ${c.status === 'pending' ? `<div class="booking-actions"><button class="btn btn-small btn-success" onclick="markCertPaid('${c.id}')">‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å</button><button class="btn btn-small btn-secondary" onclick="callClient('${c.buyer_phone}')">üìû</button></div>` : ''}
                    ${c.status === 'paid' ? `<div class="booking-actions"><button class="btn btn-small btn-primary" onclick="useCertByCode('${c.redeem_code}')">üé´ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button></div>` : ''}
                </div>`).join('');
        }
        
        async function markCertPaid(certId) {
            showToast('‚è≥ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ–º...', 'info');
            try {
                let response = await fetch(`${API_URL}/api/admin/certificates/${certId}/confirm`, { method: 'GET', headers: { 'Accept': 'application/json' } });
                if (response.ok) { handleCertPaidSuccess(await response.json()); return; }
            } catch (e) {}
            try {
                let response = await fetch(`${API_URL}/api/admin/certificates/${certId}/paid`, { method: 'POST', headers: { 'Content-Type': 'application/json' } });
                if (response.ok) { handleCertPaidSuccess(await response.json()); return; }
            } catch (e) {}
            showModal(`<div class="modal-title">‚ö†Ô∏è –û—à–∏–±–∫–∞</div><div style="text-align: center; margin: 20px 0; color: var(--text-secondary);">–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –æ–ø–ª–∞—Ç—É</div><div class="modal-actions"><button class="btn btn-primary" onclick="closeModal()">OK</button></div>`);
        }
        
        function handleCertPaidSuccess(result) {
            if (result.redeem_code) {
                showModal(`<div class="modal-title">‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –æ–ø–ª–∞—á–µ–Ω!</div><div style="text-align: center; margin: 20px 0;"><div style="background: rgba(0,255,136,0.1); border-radius: 16px; padding: 20px;"><div style="font-size: 11px; color: var(--text-secondary);">–ö–û–î –ê–ö–¢–ò–í–ê–¶–ò–ò</div><div style="font-size: 32px; font-weight: 700; letter-spacing: 4px; color: var(--accent-green); font-family: monospace;">${result.redeem_code}</div></div></div><div class="modal-actions"><button class="btn btn-primary" onclick="closeModal()">–ì–æ—Ç–æ–≤–æ</button></div>`);
                showToast('‚úÖ –ö–æ–¥: ' + result.redeem_code, 'success');
            }
            loadCerts(); loadStats();
        }
        
        async function checkCertCode() {
            const code = document.getElementById('certCodeInput').value.trim();
            if (!code || code.length < 5) { showToast('–í–≤–µ–¥–∏—Ç–µ 5-–∑–Ω–∞—á–Ω—ã–π –∫–æ–¥', 'error'); return; }
            const result = await apiCall(`/api/admin/certificates/check/${code}`);
            if (result) showCertDetails(result);
        }
        
        function showCertDetails(cert) {
            const statusText = cert.status === 'pending' ? '‚è≥ –û–∂–∏–¥–∞–µ—Ç' : cert.status === 'paid' ? '‚úÖ –ê–∫—Ç–∏–≤–µ–Ω' : 'üé´ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω';
            showModal(`<div class="modal-title">üéÅ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç</div><div style="text-align: center; margin: 16px 0;"><div style="background: rgba(0,255,136,0.1); border-radius: 16px; padding: 16px;"><div style="font-size: 28px; font-weight: 700; letter-spacing: 3px; font-family: monospace; color: var(--accent-cyan);">${cert.code}</div></div><div style="font-size: 18px; font-weight: 600; margin: 8px 0;">${cert.cert_name}</div><div style="font-size: 24px; font-weight: 700; color: var(--accent-green);">${cert.price?.toLocaleString()} ‚ÇΩ</div><div style="margin: 16px 0; padding: 12px; background: var(--bg-secondary); border-radius: 12px;">${statusText}</div></div><div class="modal-actions">${cert.status === 'paid' ? `<button class="btn btn-primary" onclick="useCertByCode('${cert.code}')">üé´ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button>` : ''}<button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
            document.getElementById('certCodeInput').value = '';
        }
        
        async function useCertByCode(code) { showModal(`<div class="modal-title">üé´ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?</div><div style="text-align: center; margin: 20px 0;"><div style="background: rgba(255,82,82,0.1); border-radius: 12px; padding: 16px; color: var(--accent-red);">‚ö†Ô∏è –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç —Å—Ç–∞–Ω–µ—Ç –Ω–µ–¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–º</div><div style="margin-top: 16px; font-size: 20px; font-weight: 700; letter-spacing: 2px;">${code}</div></div><div class="modal-actions"><button class="btn btn-primary" onclick="confirmUseCertByCode('${code}')">‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`); }
        async function confirmUseCertByCode(code) { await apiCall(`/api/admin/certificates/use-code/${code}`, { method: 'POST' }); closeModal(); loadCerts(); showToast('‚úÖ –°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'); }
        async function useCert(certId) { showModal(`<div class="modal-title">üé´ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?</div><div class="modal-actions"><button class="btn btn-primary" onclick="confirmUseCert('${certId}')">–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`); }
        async function confirmUseCert(certId) { await apiCall(`/api/admin/certificates/${certId}/use`, { method: 'POST' }); closeModal(); loadCerts(); showToast('–°–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω'); }
        
        // ============== CLIENTS ==============
        async function loadClients() { const data = await apiCall('/api/admin/clients'); if (data) { clientsData = data; renderClients(); } }
        function searchClients(query) { renderClients(query.toLowerCase()); }
        function renderClients(filter = '') {
            const container = document.getElementById('clientsList');
            let filtered = filter ? clientsData.filter(c => (c.first_name || '').toLowerCase().includes(filter) || (c.phone || '').includes(filter) || (c.username || '').toLowerCase().includes(filter)) : clientsData;
            if (filtered.length === 0) { container.innerHTML = '<div class="empty-state"><div class="empty-icon">üë•</div><div>–ù–µ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤</div></div>'; return; }
            container.innerHTML = filtered.map(c => `<div class="client-card" onclick="showClientDetails(${c.telegram_id})"><div class="client-avatar">${(c.first_name || '?')[0].toUpperCase()}</div><div class="client-info"><div class="client-name">${c.first_name || '–ö–ª–∏–µ–Ω—Ç'} ${c.last_name || ''}</div><div class="client-phone">${c.phone || '–¢–µ–ª–µ—Ñ–æ–Ω –Ω–µ —É–∫–∞–∑–∞–Ω'}</div></div><div class="client-stats"><div>${c.bookings_count || 0} –∑–∞–ø–∏—Å–µ–π</div><div>${((c.total_spent || 0) / 1000).toFixed(0)}K ‚ÇΩ</div></div></div>`).join('');
        }
        function showClientDetails(telegramId) {
            const client = clientsData.find(c => c.telegram_id === telegramId);
            if (!client) return;
            showModal(`<div class="modal-title">üë§ ${client.first_name || '–ö–ª–∏–µ–Ω—Ç'}</div><div class="card" style="margin: 16px 0;"><div class="setting-item"><span>üì± –¢–µ–ª–µ—Ñ–æ–Ω</span><a href="tel:${client.phone}" style="color: var(--accent-cyan)">${client.phone || '‚Äî'}</a></div><div class="setting-item"><span>üí¨ Telegram</span><span>@${client.username || '‚Äî'}</span></div><div class="setting-item"><span>üìÖ –ó–∞–ø–∏—Å–µ–π</span><span>${client.bookings_count || 0}</span></div><div class="setting-item"><span>üí∞ –ü–æ—Ç—Ä–∞—á–µ–Ω–æ</span><span>${(client.total_spent || 0).toLocaleString()} ‚ÇΩ</span></div></div><div class="modal-actions"><button class="btn btn-primary" onclick="window.location.href='tel:${client.phone}'">üìû –ü–æ–∑–≤–æ–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–ó–∞–∫—Ä—ã—Ç—å</button></div>`);
        }
        
        // ============== SETTINGS & SERVICES ==============
        async function loadSettings() {
            const data = await apiCall('/api/settings');
            if (data) { settings = data; document.getElementById('settingName').textContent = data.business_name || '‚Äî'; document.getElementById('settingAddress').textContent = data.business_address || '‚Äî'; document.getElementById('settingPhone').textContent = data.business_phone || '‚Äî'; }
            loadServices();
        }
        
        async function loadServices() {
            const data = await apiCall('/api/admin/services');
            if (data) {
                allServicesData = data;
                const container = document.getElementById('servicesList');
                if (container) container.innerHTML = data.slice(0, 5).map(s => `<div class="card" style="display: flex; justify-content: space-between; align-items: center;"><div><div style="font-weight: 500;">${s.name}</div><div style="color: var(--text-secondary); font-size: 14px;">${s.duration} –º–∏–Ω ¬∑ ${s.price.toLocaleString()} ‚ÇΩ</div></div><span style="color: ${s.is_active ? 'var(--accent-green)' : 'var(--text-secondary)'};">${s.is_active ? '‚úÖ' : '‚ùå'}</span></div>`).join('');
                renderServicesFull(data);
            }
        }
        
        function renderServicesFull(services) {
            const container = document.getElementById('servicesListFull');
            if (!container) return;
            const catNames = { 'floating': 'üåä –§–ª–æ–∞—Ç–∏–Ω–≥', 'couples': 'üíï –î–ª—è –¥–≤–æ–∏—Ö', 'massage': 'üíÜ –ú–∞—Å—Å–∞–∂', 'spa': 'üßñ SPA' };
            const filtered = currentServiceFilter === 'all' ? services : services.filter(s => s.category === currentServiceFilter);
            if (!filtered.length) { container.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-secondary);">–ù–µ—Ç —É—Å–ª—É–≥</div>'; return; }
            container.innerHTML = filtered.map(s => `<div class="service-card ${s.is_active ? '' : 'inactive'}" onclick="showServiceModal('${s.code}')"><div class="service-header"><div class="service-name">${s.name}</div><span class="service-status ${s.is_active ? 'active' : 'inactive'}">${s.is_active ? '–ê–∫—Ç–∏–≤–Ω–∞' : '–ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}</span></div><div class="service-meta"><span class="service-price">${s.price.toLocaleString()} ‚ÇΩ</span><span>‚è± ${s.duration} –º–∏–Ω</span></div><div class="service-category">${catNames[s.category] || s.category}</div></div>`).join('');
        }
        
        function filterServices(category) {
            currentServiceFilter = category;
            document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.category === category));
            renderServicesFull(allServicesData); haptic('light');
        }
        
        function showServiceModal(serviceCode) {
            const service = allServicesData.find(s => s.code === serviceCode);
            if (!service) return;
            const catNames = { 'floating': '–§–ª–æ–∞—Ç–∏–Ω–≥', 'couples': '–î–ª—è –¥–≤–æ–∏—Ö', 'massage': '–ú–∞—Å—Å–∞–∂', 'spa': 'SPA' };
            const escapedName = service.name.replace(/'/g, "\\'").replace(/"/g, '\\"');
            showModal(`
                <div class="modal-title">üìã ${service.name}</div>
                <div style="margin-bottom: 20px;">
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-secondary);">–¶–µ–Ω–∞</span><span style="font-weight: 600; color: var(--accent-cyan);">${service.price.toLocaleString()} ‚ÇΩ</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-secondary);">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</span><span>${service.duration} –º–∏–Ω</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid var(--border-color);"><span style="color: var(--text-secondary);">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</span><span>${catNames[service.category] || service.category}</span></div>
                    <div style="display: flex; justify-content: space-between; padding: 12px 0;"><span style="color: var(--text-secondary);">–°—Ç–∞—Ç—É—Å</span><span style="color: ${service.is_active ? 'var(--accent-green)' : 'var(--accent-red)'};">${service.is_active ? '‚úÖ –ê–∫—Ç–∏–≤–Ω–∞' : '‚ùå –ù–µ–∞–∫—Ç–∏–≤–Ω–∞'}</span></div>
                </div>
                <div class="modal-actions" style="flex-direction: column; gap: 8px;">
                    <button class="btn btn-primary" style="width: 100%;" onclick="editServicePrice('${service.code}', ${service.price})">üí∞ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É</button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="editServiceDuration('${service.code}', ${service.duration})">‚è± –ò–∑–º–µ–Ω–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="editServiceName('${service.code}', '${escapedName}')">üìù –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="editServiceCategory('${service.code}', '${service.category}')">üìÅ –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</button>
                    <button class="btn ${service.is_active ? 'btn-warning' : 'btn-success'}" style="width: 100%;" onclick="toggleService('${service.code}', ${service.is_active})">${service.is_active ? '‚ùå –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å' : '‚úÖ –ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å'}</button>
                </div>
            `);
        }
        
        function editServicePrice(code, currentPrice) {
            showModal(`<div class="modal-title">üí∞ –ò–∑–º–µ–Ω–∏—Ç—å —Ü–µ–Ω—É</div><div class="input-group"><label class="input-label">–ù–æ–≤–∞—è —Ü–µ–Ω–∞ (‚ÇΩ)</label><input type="number" class="input-field" id="newPrice" value="${currentPrice}" min="0"></div><div class="modal-actions"><button class="btn btn-primary" onclick="saveServicePrice('${code}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="showServiceModal('${code}')">–û—Ç–º–µ–Ω–∞</button></div>`);
            setTimeout(() => document.getElementById('newPrice').focus(), 100);
        }
        
        async function saveServicePrice(code) {
            const price = parseInt(document.getElementById('newPrice').value);
            if (!price || price <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Ü–µ–Ω—É', 'error'); return; }
            await apiCall(`/api/admin/services/${code}`, { method: 'PUT', body: JSON.stringify({ price }) });
            closeModal(); showToast('–¶–µ–Ω–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); loadServices();
        }
        
        // ============== –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ==============
        function editServiceDuration(code, currentDuration) {
            showModal(`
                <div class="modal-title">‚è± –ò–∑–º–µ–Ω–∏—Ç—å –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å</div>
                <div class="input-group">
                    <label class="input-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω—É—Ç)</label>
                    <input type="number" class="input-field" id="newDuration" value="${currentDuration}" min="15" max="480" step="15">
                </div>
                <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 16px;">
                    <button class="btn btn-small btn-secondary" onclick="setDuration(30)">30 –º–∏–Ω</button>
                    <button class="btn btn-small btn-secondary" onclick="setDuration(45)">45 –º–∏–Ω</button>
                    <button class="btn btn-small btn-secondary" onclick="setDuration(60)">60 –º–∏–Ω</button>
                    <button class="btn btn-small btn-secondary" onclick="setDuration(90)">90 –º–∏–Ω</button>
                    <button class="btn btn-small btn-secondary" onclick="setDuration(120)">120 –º–∏–Ω</button>
                </div>
                <div class="modal-actions">
                    <button class="btn btn-primary" onclick="saveServiceDuration('${code}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                    <button class="btn btn-secondary" onclick="showServiceModal('${code}')">–û—Ç–º–µ–Ω–∞</button>
                </div>
            `);
            setTimeout(() => document.getElementById('newDuration').focus(), 100);
        }
        
        function setDuration(minutes) {
            document.getElementById('newDuration').value = minutes;
        }
        
        async function saveServiceDuration(code) {
            const duration = parseInt(document.getElementById('newDuration').value);
            if (!duration || duration < 15) { showToast('–ú–∏–Ω–∏–º—É–º 15 –º–∏–Ω—É—Ç', 'error'); return; }
            if (duration > 480) { showToast('–ú–∞–∫—Å–∏–º—É–º 480 –º–∏–Ω—É—Ç', 'error'); return; }
            await apiCall(`/api/admin/services/${code}`, { method: 'PUT', body: JSON.stringify({ duration }) });
            closeModal(); showToast('–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); loadServices();
        }
        // ============== –ö–û–ù–ï–¶ –ù–û–í–û–ô –§–£–ù–ö–¶–ò–ò ==============
        
        function editServiceName(code, currentName) {
            showModal(`<div class="modal-title">üìù –ò–∑–º–µ–Ω–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ</div><div class="input-group"><label class="input-label">–ù–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="input-field" id="newName" value="${currentName}"></div><div class="modal-actions"><button class="btn btn-primary" onclick="saveServiceName('${code}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="showServiceModal('${code}')">–û—Ç–º–µ–Ω–∞</button></div>`);
            setTimeout(() => document.getElementById('newName').focus(), 100);
        }
        
        async function saveServiceName(code) {
            const name = document.getElementById('newName').value.trim();
            if (!name) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error'); return; }
            await apiCall(`/api/admin/services/${code}`, { method: 'PUT', body: JSON.stringify({ name }) });
            closeModal(); showToast('–ù–∞–∑–≤–∞–Ω–∏–µ –æ–±–Ω–æ–≤–ª–µ–Ω–æ'); loadServices();
        }
        
        function editServiceCategory(code, currentCategory) {
            showModal(`<div class="modal-title">üìÅ –ò–∑–º–µ–Ω–∏—Ç—å –∫–∞—Ç–µ–≥–æ—Ä–∏—é</div><div style="display: flex; flex-direction: column; gap: 8px; margin-bottom: 16px;"><button class="btn ${currentCategory === 'floating' ? 'btn-primary' : 'btn-secondary'}" onclick="saveServiceCategory('${code}', 'floating')">üåä –§–ª–æ–∞—Ç–∏–Ω–≥</button><button class="btn ${currentCategory === 'couples' ? 'btn-primary' : 'btn-secondary'}" onclick="saveServiceCategory('${code}', 'couples')">üíï –î–ª—è –¥–≤–æ–∏—Ö</button><button class="btn ${currentCategory === 'massage' ? 'btn-primary' : 'btn-secondary'}" onclick="saveServiceCategory('${code}', 'massage')">üíÜ –ú–∞—Å—Å–∞–∂</button><button class="btn ${currentCategory === 'spa' ? 'btn-primary' : 'btn-secondary'}" onclick="saveServiceCategory('${code}', 'spa')">üßñ SPA</button></div><div class="modal-actions"><button class="btn btn-secondary" onclick="showServiceModal('${code}')">–û—Ç–º–µ–Ω–∞</button></div>`);
        }
        
        async function saveServiceCategory(code, category) { await apiCall(`/api/admin/services/${code}`, { method: 'PUT', body: JSON.stringify({ category }) }); closeModal(); showToast('–ö–∞—Ç–µ–≥–æ—Ä–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∞'); loadServices(); }
        async function toggleService(code, isActive) { await apiCall(`/api/admin/services/${code}/toggle`, { method: 'POST' }); closeModal(); showToast(isActive ? '–£—Å–ª—É–≥–∞ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞' : '–£—Å–ª—É–≥–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞'); loadServices(); }
        
        function showAddServiceModal() {
            showModal(`<div class="modal-title">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—Å–ª—É–≥—É</div><div class="input-group"><label class="input-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" class="input-field" id="newServiceName" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ —É—Å–ª—É–≥–∏"></div><div class="input-group"><label class="input-label">–¶–µ–Ω–∞ (‚ÇΩ)</label><input type="number" class="input-field" id="newServicePrice" placeholder="3000" min="0"></div><div class="input-group"><label class="input-label">–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–º–∏–Ω)</label><input type="number" class="input-field" id="newServiceDuration" placeholder="60" min="15" value="60"></div><div class="input-group"><label class="input-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label><select class="input-field" id="newServiceCategory"><option value="floating">üåä –§–ª–æ–∞—Ç–∏–Ω–≥</option><option value="couples">üíï –î–ª—è –¥–≤–æ–∏—Ö</option><option value="massage">üíÜ –ú–∞—Å—Å–∞–∂</option><option value="spa">üßñ SPA</option></select></div><div class="modal-actions"><button class="btn btn-primary" onclick="createService()">–°–æ–∑–¥–∞—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`);
            setTimeout(() => document.getElementById('newServiceName').focus(), 100);
        }
        
        async function createService() {
            const name = document.getElementById('newServiceName').value.trim();
            const price = parseInt(document.getElementById('newServicePrice').value);
            const duration = parseInt(document.getElementById('newServiceDuration').value) || 60;
            const category = document.getElementById('newServiceCategory').value;
            if (!name) { showToast('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ', 'error'); return; }
            if (!price || price <= 0) { showToast('–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É', 'error'); return; }
            const code = name.toLowerCase().replace(/[–∞-—è—ë]/g, c => ({–∞:'a',–±:'b',–≤:'v',–≥:'g',–¥:'d',–µ:'e',—ë:'e',–∂:'zh',–∑:'z',–∏:'i',–π:'y',–∫:'k',–ª:'l',–º:'m',–Ω:'n',–æ:'o',–ø:'p',—Ä:'r',—Å:'s',—Ç:'t',—É:'u',—Ñ:'f',—Ö:'h',—Ü:'ts',—á:'ch',—à:'sh',—â:'sch',—ä:'',—ã:'y',—å:'',—ç:'e',—é:'yu',—è:'ya'}[c] || c)).replace(/[^a-z0-9]+/g, '-').slice(0, 20) + '-' + Date.now().toString().slice(-6);
            await apiCall('/api/admin/services', { method: 'POST', body: JSON.stringify({ code, name, price, duration, category }) });
            closeModal(); showToast('–£—Å–ª—É–≥–∞ —Å–æ–∑–¥–∞–Ω–∞'); loadServices();
        }
        
        function editSetting(key) {
            const labels = { 'business_name': '–ù–∞–∑–≤–∞–Ω–∏–µ', 'business_address': '–ê–¥—Ä–µ—Å', 'business_phone': '–¢–µ–ª–µ—Ñ–æ–Ω' };
            showModal(`<div class="modal-title">‚úèÔ∏è ${labels[key]}</div><div class="input-group"><input type="text" class="input-field" id="settingInput" value="${settings[key] || ''}"></div><div class="modal-actions"><button class="btn btn-primary" onclick="saveSetting('${key}')">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`);
            setTimeout(() => document.getElementById('settingInput').focus(), 100);
        }
        
        async function saveSetting(key) { await apiCall('/api/admin/settings', { method: 'POST', body: JSON.stringify({ [key]: document.getElementById('settingInput').value.trim() }) }); closeModal(); loadSettings(); showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); }
        
        function showBroadcastModal() { showModal(`<div class="modal-title">üì¢ –†–∞—Å—Å—ã–ª–∫–∞</div><div class="input-group"><label class="input-label">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</label><textarea class="input-field" id="broadcastText" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç..."></textarea></div><p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;">–ë—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤—Å–µ–º –ø–æ–¥–ø–∏—Å—á–∏–∫–∞–º</p><div class="modal-actions"><button class="btn btn-primary" onclick="sendBroadcast()">üì® –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button><button class="btn btn-secondary" onclick="closeModal()">–û—Ç–º–µ–Ω–∞</button></div>`); }
        async function sendBroadcast() { const text = document.getElementById('broadcastText').value.trim(); if (!text) { showToast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç', 'error'); return; } await apiCall('/api/admin/broadcast', { method: 'POST', body: JSON.stringify({ text }) }); closeModal(); showToast('–†–∞—Å—Å—ã–ª–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞'); }
        
        // ============== MODAL & TOAST ==============
        function showModal(content) { document.getElementById('modalContent').innerHTML = content; document.getElementById('modal').classList.add('active'); haptic('medium'); }
        function closeModal() { document.getElementById('modal').classList.remove('active'); }
        function refreshApp() { document.querySelector('.refresh-btn').classList.add('spinning'); setTimeout(() => window.location.reload(), 300); }
        
        function showToast(message, type = 'success') {
            let toast = document.getElementById('toast');
            if (!toast) { toast = document.createElement('div'); toast.id = 'toast'; toast.style.cssText = 'position: fixed; bottom: 100px; left: 50%; transform: translateX(-50%); padding: 12px 24px; border-radius: 12px; z-index: 10000; opacity: 0; transition: opacity 0.3s; font-weight: 500;'; document.body.appendChild(toast); }
            toast.textContent = message;
            toast.style.background = type === 'error' ? 'var(--accent-red)' : 'var(--accent-green)';
            toast.style.color = type === 'error' ? '#fff' : '#000';
            toast.style.opacity = '1';
            setTimeout(() => { toast.style.opacity = '0'; }, 2500);
            haptic(type === 'error' ? 'error' : 'success');
        }
        
        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });
        
        function toggleTheme() {
            const html = document.documentElement;
            const currentTheme = html.getAttribute('data-theme');
            if (currentTheme === 'pelican') { html.removeAttribute('data-theme'); localStorage.removeItem('pelican-admin-theme'); document.querySelector('.theme-toggle').textContent = 'ü¶©'; }
            else { html.setAttribute('data-theme', 'pelican'); localStorage.setItem('pelican-admin-theme', 'pelican'); document.querySelector('.theme-toggle').textContent = 'üåô'; }
        }
        (function() { const savedTheme = localStorage.getItem('pelican-admin-theme'); if (savedTheme) { document.documentElement.setAttribute('data-theme', savedTheme); document.querySelector('.theme-toggle').textContent = 'üåô'; } })();
    </script>
</body>
</html>
